<div class="page-container">
    <!-- Initial View: Amount & Method Selection -->
    <div *ngIf="(!depositMethod || depositMethod === 'cards') && !isLoading" class="initial-view">
        <div class="deposit-header">
            <h2>üí∞ Deposit Money</h2>
            <p>Choose your preferred deposit method</p>
        </div>

        <!-- Target Card Selection -->
        <div class="form-section-3d" *ngIf="userCards.length > 0">
            <label>Deposit Into Card <span class="required">*</span></label>
            <select [(ngModel)]="selectedTargetCardId" class="method-dropdown" [disabled]="isLoading">
                <option *ngFor="let card of userCards" [value]="card.cardId">
                    {{ card.cardType }} - {{ card.cardNumber }} ({{ card.balance | currency }})
                </option>
            </select>
        </div>
        <div class="info-box warning-card" *ngIf="userCards.length === 0 && !isLoading">
            <p>‚ö†Ô∏è You don't have any active cards. Please apply for a card first.</p>
        </div>

        <!-- Amount Input (Always First) -->
        <div class="amount-section" [class.disabled]="userCards.length === 0">
            <label for="depositUsdAmountInput">Amount <span class="required">*</span></label>
            <div class="amount-input-group">
                <span class="currency-symbol">$</span>
                <input type="number" id="depositUsdAmountInput" [(ngModel)]="enteredUsdAmount"
                    (ngModelChange)="onAmountChange($event)" placeholder="Enter amount" min="10" step="0.01"
                    class="amount-input" [disabled]="isLoading || userCards.length === 0">
                <span class="currency-code">USD</span>
            </div>
            <div class="fee-info">
                <span>Transaction Fee:</span>
                <span><del>$1.20</del> <span class="free-badge">FREE</span></span>
            </div>
        </div>

        <!-- Payment Method Dropdown -->
        <div class="method-selection" *ngIf="enteredUsdAmount && enteredUsdAmount >= 10">
            <label for="paymentMethod">Select Deposit Method <span class="required">*</span></label>
            <select id="paymentMethod" [(ngModel)]="depositMethod" (change)="onMethodChange()" class="method-dropdown"
                [disabled]="isLoading">
                <option [value]="null" disabled selected>Choose a method</option>
                <option *ngFor="let method of paymentMethods" [value]="method.value">
                    {{ method.icon }} {{ method.label }}
                </option>
            </select>
        </div>

        <!-- Payment Cards Grid -->
        <div *ngIf="showPaymentCards" class="payment-cards-grid">
            <div *ngFor="let card of paymentCards" class="payment-card" [style.background]="card.gradient"
                (click)="selectPaymentCard(card.id)">
                <div class="card-content">
                    <h4>{{ card.name }}</h4>
                    <span class="card-icon">üí≥</span>
                </div>
                <div class="card-footer">
                    <span class="status-badge active">Available</span>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div *ngIf="enteredUsdAmount && enteredUsdAmount > 0" class="deposit-summary">
            <span>You'll Deposit:</span>
            <h3>${{ enteredUsdAmount }}</h3>
        </div>
    </div>

    <!-- P2P Next Button (Separate Block) -->
    <div *ngIf="depositMethod === 'p2p' && currentStep === 0" class="initial-view">
        <div class="deposit-header">
            <h2>üí∞ Deposit Money</h2>
            <p>P2P Payments Selected</p>
        </div>

        <div class="deposit-summary">
            <span>You'll Deposit:</span>
            <h3>${{ enteredUsdAmount }}</h3>
        </div>

        <div class="action-section">
            <button class="btn-3d btn-primary" (click)="proceedWithP2P()">
                Next ‚Üí
            </button>
        </div>
    </div>

    <!-- P2P Flow (Existing) -->
    <div *ngIf="depositMethod === 'p2p' && currentStep > 0">
        <!-- Stepper -->
        <div class="stepper-card">
            <div class="stepper">
                <div class="step-item" [class.completed]="currentStep > 1" [class.active]="currentStep === 1">
                    <div class="step-circle" (click)="goToStep(1)">
                        <span *ngIf="currentStep > 1">‚úì</span>
                        <span *ngIf="currentStep <= 1">1</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-label">Select Bank</div>
                </div>
                <div class="step-item" [class.completed]="currentStep > 2" [class.active]="currentStep === 2">
                    <div class="step-circle" (click)="goToStep(2)">
                        <span *ngIf="currentStep > 2">‚úì</span>
                        <span *ngIf="currentStep <= 2">2</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-label">Pay & Confirm</div>
                </div>
                <div class="step-item" [class.active]="currentStep === 3">
                    <div class="step-circle">
                        <span>3</span>
                    </div>
                    <div class="step-label">Upload Proof</div>
                </div>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="info-card success-card">
            <h4>P2P EasyFinora Payments</h4>
            <p>Choose bank account from your country region only</p>
        </div>

        <div class="info-card warning-card">
            <h5>Payment Processing Information:</h5>
            <p><strong>International Payments:</strong> Processing time: 4-5 working days</p>
            <p><strong>Regional Payments:</strong> Processing time: 6 hours</p>
        </div>

        <!-- Step 1: Select Bank Account -->
        <div *ngIf="currentStep === 1" class="step-content">
            <div *ngFor="let region of regions" class="region-section">
                <h4 class="region-title">{{ region }} Region</h4>
                <div class="accounts-grid">
                    <div *ngFor="let account of getAccountsByRegion(region)" class="account-card"
                        (click)="selectAccount(account)">
                        <div class="account-header">
                            <div class="account-info">
                                <img [src]="account.flag" [alt]="account.country" class="flag-img">
                                <div class="account-details">
                                    <span class="country-name">{{ account.country }}</span>
                                    <span class="account-number">{{ account.currency }} | {{ account.accountNumber
                                        }}</span>
                                </div>
                            </div>
                            <span class="chevron">‚Ä∫</span>
                        </div>
                        <div class="verified-badge">
                            <span class="check-icon">‚úì</span>
                            <span>Verified By EasyFinora Payments</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Payment Confirmation & Amount -->
        <div *ngIf="currentStep === 2 && selectedAccount" class="step-content">
            <div class="bank-details-modal">
                <div class="modal-header-section">
                    <img [src]="selectedAccount.flag" [alt]="selectedAccount.country" class="flag-large">
                    <div>
                        <h5>{{ selectedAccount.country }}</h5>
                        <p>{{ selectedAccount.currency }} | {{ selectedAccount.accountNumber }}</p>
                        <span class="verified-badge-small">
                            <span class="check-icon">‚úì</span> Verified By EasyFinora Payments
                        </span>
                    </div>
                </div>

                <div class="alert-info">
                    <span class="info-icon">‚Ñπ</span>
                    Please send exactly <strong>{{ localAmount | number:'1.0-0' }} {{ localCurrency
                        }}</strong> (equivalent to ${{ enteredUsdAmount | number:'1.2-2' }} USD) to the account below.
                    Use local
                    bank transfer
                    within {{ selectedAccount.country }} via electronic funds transfer (EFT) or direct deposit.
                </div>

                <div class="bank-details-grid">
                    <div class="detail-item">
                        <h6>Account Holder Name</h6>
                        <p>{{ selectedAccount.accountHolder }}</p>
                    </div>
                    <div class="detail-item">
                        <h6>Bank Name</h6>
                        <p>{{ selectedAccount.bankName }}</p>
                    </div>
                    <div class="detail-item">
                        <h6>Branch Name</h6>
                        <p>{{ selectedAccount.branchName }}</p>
                    </div>
                    <div class="detail-item" *ngIf="selectedAccount.routingNumber">
                        <h6>Routing Number</h6>
                        <p>{{ selectedAccount.routingNumber }}</p>
                    </div>
                    <div class="detail-item" *ngIf="selectedAccount.sortCode">
                        <h6>Sort Code</h6>
                        <p>{{ selectedAccount.sortCode }}</p>
                    </div>
                    <div class="detail-item" *ngIf="selectedAccount.ifscCode">
                        <h6>IFSC Code</h6>
                        <p>{{ selectedAccount.ifscCode }}</p>
                    </div>
                    <div class="detail-item">
                        <h6>IBAN</h6>
                        <p>{{ selectedAccount.iban }}</p>
                    </div>
                    <div class="detail-item full-width">
                        <h6>Bank Address</h6>
                        <p>{{ selectedAccount.bankAddress }}</p>
                    </div>
                    <div class="detail-item">
                        <h6>Receiver Number</h6>
                        <p>{{ selectedAccount.receiverNumber }}</p>
                    </div>
                </div>

                <div class="payment-form">
                    <div class="checkbox-group">
                        <input type="checkbox" id="paymentConfirmed" [(ngModel)]="paymentConfirmed"
                            class="custom-checkbox">
                        <label for="paymentConfirmed">
                            I confirm that I have sent the payment to the above bank account
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="localCurrencyDisplayInput">Amount Sent ({{ localCurrency }})</label>
                        <div class="input-with-hint">
                            <input type="number" id="localCurrencyDisplayInput" [ngModel]="localAmount"
                                class="form-control" placeholder="Enter amount in {{ localCurrency }}" readonly min="0"
                                step="1">
                            <small class="hint-text">Required: ${{ enteredUsdAmount | number:'1.2-2' }} USD</small>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" (click)="currentStep = 1">Back</button>
                        <button class="btn-3d" (click)="proceedToProof()">Continue</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Upload Proof -->
        <div *ngIf="currentStep === 3" class="step-content">
            <div class="upload-section">
                <h4>Upload Payment Proof</h4>
                <p>Please upload a screenshot or receipt of your payment transaction</p>

                <div class="file-upload-area">
                    <input type="file" id="proof" (change)="onFileSelected($event)" accept="image/*,.pdf"
                        class="file-input">
                    <label for="proof" class="file-label">
                        <span class="upload-icon">üìÑ</span>
                        <span *ngIf="!proofFile" class="upload-text">Click to upload proof of payment</span>
                        <span *ngIf="proofFile" class="file-name">{{ proofFile.name }}</span>
                        <span class="upload-hint">Supported formats: JPG, PNG, PDF (Max 5MB)</span>
                    </label>
                </div>

                <div class="summary-box">
                    <h5>Payment Summary</h5>
                    <div class="summary-row">
                        <span>Bank:</span>
                        <span>{{ selectedAccount?.bankName }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Account:</span>
                        <span>{{ selectedAccount?.accountNumber }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Amount:</span>
                        <div class="amount-stack">
                            <span class="amount-highlight">{{ localAmount | number:'1.0-0' }} {{
                                localCurrency }}</span>
                            <span class="amount-sub">(${{ enteredUsdAmount | number:'1.2-2' }} USD)</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" (click)="currentStep = 2">Back</button>
                    <button class="btn-3d" (click)="submitDeposit()" [disabled]="isLoading">
                        <span *ngIf="!isLoading">Submit for Review</span>
                        <span *ngIf="isLoading">Processing...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Card/Crypto Forms -->
    <div *ngIf="showCardModal" class="modal-overlay" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ selectedCardName }}</h3>
                <button class="close-btn" (click)="closeModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div class="amount-display">
                    <span>Amount to Deposit:</span>
                    <h2>${{ enteredUsdAmount }} USD</h2>
                </div>

                <!-- Crypto Form -->
                <div *ngIf="selectedCard === 'crypto'" class="crypto-form">
                    <div class="wallet-section">
                        <label>Send to Wallet Address:</label>
                        <div class="wallet-address-box">
                            <code>{{ cryptoWalletAddress }}</code>
                            <button class="btn-copy" (click)="copyWalletAddress()">Copy</button>
                        </div>
                    </div>

                    <div class="proof-upload">
                        <label>Upload Transaction Proof:</label>
                        <input type="file" (change)="onCryptoFileSelected($event)" accept="image/*,.pdf">
                        <span *ngIf="cryptoProofFile" class="file-name">{{ cryptoProofFile.name }}</span>
                    </div>

                    <button class="btn-3d btn-primary" (click)="submitCardPayment()" [disabled]="isLoading">
                        <span *ngIf="!isLoading">Submit Deposit</span>
                        <span *ngIf="isLoading">Processing...</span>
                    </button>
                </div>

                <!-- Card Payment Form -->
                <div *ngIf="selectedCard === 'mastercard' || selectedCard === 'discover' || selectedCard === 'amex'"
                    class="card-form">
                    <div class="form-group">
                        <label>Card Holder Name</label>
                        <input type="text" [(ngModel)]="cardDetails.holderName" placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" [(ngModel)]="cardDetails.cardNumber" (input)="formatCardNumber()"
                            placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <div class="expiry-inputs">
                                <input type="text" [(ngModel)]="cardDetails.expiryMonth" placeholder="MM" maxlength="2">
                                <span>/</span>
                                <input type="text" [(ngModel)]="cardDetails.expiryYear" placeholder="YY" maxlength="2">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" [(ngModel)]="cardDetails.cvv" placeholder="123" maxlength="3">
                        </div>
                    </div>

                    <button class="btn-3d btn-primary" (click)="submitCardPayment()">Submit Payment</button>
                </div>

                <!-- Bank Transfer Form -->
                <div *ngIf="selectedCard === 'bank'" class="bank-form">
                    <div class="form-group">
                        <label>Account Holder Name</label>
                        <input type="text" placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" placeholder="1234567890">
                    </div>

                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" placeholder="Bank of America">
                    </div>

                    <div class="form-group">
                        <label>IBAN / Routing Number</label>
                        <input type="text" placeholder="GB29BARC20201530093459">
                    </div>

                    <button class="btn-3d btn-primary" (click)="submitCardPayment()">Submit</button>
                </div>

                <!-- Google Pay Form -->
                <div *ngIf="selectedCard === 'gpay'" class="gpay-form">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" placeholder="john@gmail.com">
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" placeholder="+1 234 567 8900">
                    </div>

                    <button class="btn-3d btn-primary" (click)="submitCardPayment()">Continue with Google Pay</button>
                </div>
            </div>
        </div>
    </div>
</div>