<div class="section payment-container">
  <h2 class="section-title">Payment Method</h2>

  <!-- Custom Dropdown -->
  <div class="method-selector">
    <label class="field-label">Select Payment Method</label>
    <div class="custom-select-wrapper">
      <select class="form-select payment-dropdown" [(ngModel)]="selectedMethodId"
        (change)="onMethodChange(selectedMethodId)">
        <option *ngFor="let method of paymentMethods" [value]="method.id">
          {{ method.name }}
        </option>
      </select>
      <div class="selected-icon">
        <img [src]="paymentMethods[0].id === selectedMethodId ? paymentMethods[0].icon : 
                   (paymentMethods[1].id === selectedMethodId ? paymentMethods[1].icon : 
                   (paymentMethods[2].id === selectedMethodId ? paymentMethods[2].icon : 
                   paymentMethods[3].icon))" height="20" *ngIf="selectedMethodId">
      </div>
    </div>
  </div>

  <!-- Dynamic Payment Forms -->
  <div class="payment-form-area mt-4 animate-fade-in"
    *ngIf="selectedMethodId === 'card' || selectedMethodId === 'finora'">
    <div class="card-inputs">
      <div class="form-group mb-3">
        <label class="field-label">Card Number</label>
        <div class="input-wrapper">
          <i class="pi pi-credit-card"></i>
          <input type="text" placeholder="0000 0000 0000 0000" class="form-control" [value]="card.number"
            (input)="formatCardNumber($event)" [class.error-border]="cardErrors.number">
        </div>
        <div class="error-msg" *ngIf="cardErrors.number">Must be 16 digits</div>
      </div>

      <div class="row">
        <div class="col-6">
          <div class="form-group mb-3">
            <label class="field-label">Expiry Date</label>
            <input type="text" placeholder="MM/YY" class="form-control" [value]="card.expiry"
              (input)="formatExpiry($event)" [class.error-border]="cardErrors.expiry">
            <div class="error-msg" *ngIf="cardErrors.expiry">Invalid Date</div>
          </div>
        </div>
        <div class="col-6">
          <div class="form-group mb-3">
            <label class="field-label">CVV</label>
            <input type="text" placeholder="123" class="form-control" [value]="card.cvv" (input)="formatCVV($event)"
              [class.error-border]="cardErrors.cvv">
            <div class="error-msg" *ngIf="cardErrors.cvv">3 digits</div>
          </div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label class="field-label">Card Holder Name</label>
        <input type="text" placeholder="Name on card" class="form-control" [(ngModel)]="card.holder">
      </div>

      <!-- Easy Finora Verification -->
      <div class="finora-check mt-3" *ngIf="selectedMethodId === 'finora'">
        <div class="alert alert-info d-flex align-items-center" *ngIf="isVerified">
          <i class="pi pi-check-circle me-2"></i>
          <div>
            Verified! Available Balance: <strong class="text-success">${{ verifiedBalance | number:'1.2-2' }}</strong>
          </div>
        </div>

        <div class="alert alert-danger" *ngIf="verificationMessage">
          {{ verificationMessage }}
        </div>

        <button type="button" class="btn btn-outline-primary w-100" (click)="verifyFinora()" [disabled]="isVerifying">
          <span *ngIf="isVerifying"><i class="pi pi-spin pi-spinner"></i> Verifying...</span>
          <span *ngIf="!isVerifying">Verify Card Balance</span>
        </button>
      </div>
    </div>
  </div>

  <div class="other-methods-msg mt-4 p-3 border rounded text-center animate-fade-in"
    *ngIf="selectedMethodId !== 'card' && selectedMethodId !== 'finora'">
    <i class="pi pi-info-circle mb-2" style="font-size: 2rem; color: #f85606"></i>
    <p>You will be redirected to {{ selectedMethodId | uppercase }} secure checkout page after clicking <strong>Place
        Order</strong>.</p>
  </div>

  <div class="actions mt-4">
    <button class="btn btn-save-payment" (click)="saveCard()" [disabled]="selectedMethodId === 'finora' && !isVerified">
      Confirm & Continue
    </button>
  </div>
</div>